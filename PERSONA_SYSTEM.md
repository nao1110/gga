# ペルソナ自動割り当てシステム

## 概要

CareerTreでは、キャリアコンサルタント実技試験の本番環境を再現するため、受験者の実技練習回数に応じて自動的にペルソナ（相談者役）が割り当てられます。

## ペルソナ一覧

5種類のペルソナが順番に割り当てられます：

### ペルソナ1：佐藤 悠斗（24歳）
- **職業**: 大手IT企業の営業職（入社2年目）
- **相談内容**: 大学新卒/入社後のリアリティショック、適性の不一致。「この会社で自分のキャリアパスが見えず、テレアポばかりで成長できない。早く転職すべきか悩んでいます。」

### ペルソナ2：田中 恵子（48歳）
- **職業**: 中堅メーカーの経理・財務担当（課長代理）
- **家族構成**: 夫、子2人、実母（要介護2）と同居
- **相談内容**: ライフイベント：介護と仕事の両立。「仕事も介護も中途半端で、心身の疲労が限界です。キャリアを断念して介護に専念すべきでしょうか。」

### ペルソナ3：中村 健太（35歳）
- **職業**: 大手食品メーカーの契約社員（研究開発部門、勤続8年）
- **家族構成**: 独身
- **相談内容**: 雇用形態：非正規社員の不安定な立場。「正社員と同等の貢献をしているのに契約社員のままで、将来の結婚や生活の不安定さに限界を感じています。」

### ペルソナ4：小林 雅人（53歳）
- **職業**: 総合商社の管理部門（人事・総務、部長職）
- **家族構成**: 妻、子2人（独立済）
- **相談内容**: 組織再編：早期退職制度の利用検討。「上乗せがあるうちに退職すべきか、残るべきか。50代で新しい仕事が見つかるのかが一番不安です。」

### ペルソナ5：山本 義雄（61歳）
- **職業**: 精密機械メーカーの製造部門（定年後、再雇用契約社員）
- **家族構成**: 妻
- **相談内容**: シニア層：定年後・再雇用での不適応。「給与が安く、後輩のサポートばかりでやりがいを感じられない。このまましがみつくべきか迷っています。」

## 自動割り当てロジック

### 基本ルール
受験者の**完了済み実技練習回数**に基づいて、1→2→3→4→5→1→2...とループして割り当てられます。

```
完了回数 0回 → 次の予約はペルソナ1
完了回数 1回 → 次の予約はペルソナ2
完了回数 2回 → 次の予約はペルソナ3
完了回数 3回 → 次の予約はペルソナ4
完了回数 4回 → 次の予約はペルソナ5
完了回数 5回 → 次の予約はペルソナ1（ループ）
```

### 技術的な実装

#### 1. 予約作成時
受験者が予約を作成した時点では、`persona_id`は**NULL**のままです。

#### 2. トレーナーが予約を承認時
トレーナーが予約を承認すると、以下の処理が自動実行されます：
1. その受験者の完了済み実技練習回数を取得
2. `(完了回数 % 5) + 1`でペルソナIDを計算
3. 予約レコードの`persona_id`カラムに自動設定

#### 3. 表示時
ペルソナ情報は以下の画面で表示されます：
- **トレーナーマイページ**：承認待ち・確定済み・完了済みの全予約リスト
- **フィードバック入力画面**：実技練習情報セクション

## トレーナーが見る情報

### 承認待ち予約（pending）
```
山田 太郎 さん [ペルソナ1]

ペルソナ情報：
佐藤 悠斗 さん（24歳）
職業：大手IT企業の営業職（入社2年目）
相談内容：大学新卒/入社後のリアリティショック...
```

### 実施予定の予約（confirmed）
同じくペルソナ情報が表示され、トレーナーは事前に相談者役の設定を確認できます。

### フィードバック入力画面
実技練習情報として、受験者名と共にペルソナ情報が明確に表示されます。

## 実技試験本番との対応

本番のキャリアコンサルタント実技試験では：
- **試験開始5分前**にペルソナ（相談者設定）が発表される
- CareerTreでは、承認時点でペルソナが確定し、トレーナーが事前に確認できる
- これにより、トレーナーは適切な相談者役を演じる準備ができる

## テスト方法

### 1. 新規受験者で順番にテスト
```sql
-- 受験者の完了回数を確認
SELECT u.name, COUNT(r.id) as completed_count
FROM users u
LEFT JOIN reserves r ON u.id = r.user_id AND r.status = 'completed'
WHERE u.id = 1
GROUP BY u.id;
```

### 2. トレーナーとしてログイン
- **ログイン情報**: tanaka.trainer@example.com / password123
- マイページで承認待ち予約を確認
- ペルソナバッジと詳細情報が表示されることを確認

### 3. 予約を承認
- 承認ボタンをクリック
- データベースで`persona_id`が自動設定されたことを確認

### 4. フィードバック入力画面
- 「レポート入力」ボタンから遷移
- 実技練習情報にペルソナ詳細が表示されることを確認

## データベース確認クエリ

```sql
-- ペルソナ割り当て状況を確認
SELECT 
    r.id,
    u.name as user_name,
    r.meeting_date,
    r.status,
    r.persona_id,
    p.persona_name,
    (SELECT COUNT(*) 
     FROM reserves r2 
     WHERE r2.user_id = r.user_id 
     AND r2.status = 'completed' 
     AND r2.meeting_date < r.meeting_date) as completed_count
FROM reserves r
LEFT JOIN users u ON r.user_id = u.id
LEFT JOIN personas p ON r.persona_id = p.id
ORDER BY r.id;
```

## UIデザイン

### ペルソナバッジ
- グラデーション背景（紫系）
- 「ペルソナ1」「ペルソナ2」等の表示
- ユーザーアイコン付き

### ペルソナ情報カード
- グレー背景（`#f8f9fa`）
- 左に紫のボーダーライン
- 氏名（年齢）、職業、相談内容を構造化して表示

## 今後の拡張

- ペルソナの追加・編集機能
- トレーナーが手動でペルソナを変更する機能
- ペルソナごとの統計情報（どのペルソナで何回練習したか）

---

**更新日**: 2025年11月8日
